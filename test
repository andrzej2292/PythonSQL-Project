#sql alchemy
#rozwiazac problem co  jesli odpalamy 1 raz i jeszcze nic nie ma, wtedy current nie zadziala

import mysql.connector
from mysql.connector import Error

mydb = mysql.connector.connect(user='root', password='MyNewPass',
                               host='127.0.0.1',
                               database='my_portfolio', auth_plugin='mysql_native_password')

mycursor = mydb.cursor()
command = ""
help = """
Type:
"current" to display all your current assets
"add" to add the new asset
"remove" to remove the existing asset
"edit" to amend the existing asset
"reset" to reset all assets to default values
"quit" to close the program
"""


print("""
Welcome to your assets manager tool!

Below you can see your current assets:

name, type, amount, value_per_unit_pln, value_total_pln
""")

mycursor.execute("DROP TABLE IF EXISTS current_assets;")

mycursor.execute("""CREATE TABLE current_assets (
 name varchar(50),
 type varchar(50),
 amount int, 
 value_per_unit_pln int ,  
 value_total_pln int AS (amount * value_per_unit_pln)
 )""")

sql_formula = "INSERT INTO current_assets (name, type, amount, value_per_unit_pln) VALUES (%s, %s, %s, %s)"

asset1 = ('btc', "cryptocurrency", 2, 29700)
asset2 = ('usd', 'currency', 10000, 3.80)
asset3 = ('cdr', 'shares', 30, 250)

mycursor.execute(sql_formula, asset1)
mycursor.execute(sql_formula, asset2)
mycursor.execute(sql_formula, asset3)
mydb.commit()
mycursor.execute("SELECT * FROM my_portfolio.current_assets")
my_result = mycursor.fetchall()
for x in my_result:
    print(x)

print(help)


while True:
    command = str.lower(input('> '))
    if command == "current":
        mycursor.execute("SELECT * FROM my_portfolio.current_assets")
        my_result = mycursor.fetchall()
        for x in my_result:
            print(x)

    elif command == "add":
        sql_formula = "INSERT INTO current_assets (name, type, amount, value_per_unit_pln) VALUES (%s, %s, %s, %s)"
        name_new = str.lower(input("Please type security name that you would like to add > "))
        type_new = str.lower(input("Choose security type that you would like to add: shares/bonds/currency/cryptocurrency > "))
        amount_new = int(input("Please type the amount of security that you would like to add > "))
        value_per_unit_new = int(input("Please type the value per unit of the security that you would like to add > "))
        asset_new = (f'{name_new}', f'{type_new}', f'{amount_new}', f'{value_per_unit_new}')
        mycursor.execute(sql_formula, asset_new)
        mydb.commit()

        print("""
New security has been added!
        
Your portfolio currently consists of:
""")

        mycursor.execute("SELECT * FROM my_portfolio.current_assets")
        my_result = mycursor.fetchall()
        for x in my_result:
            print(x)
        print(help)

    elif command == "remove":
        asset_to_delete = str.lower(input("Please type security name that you would like to remove > "))
        sql_formula = f'DELETE FROM current_assets WHERE name = "{asset_to_delete}"'
        mycursor.execute(sql_formula)

        print("""
Security has been removed!

Your portfolio currently consists of:
        """)

        mydb.commit()
        mycursor.execute("SELECT * FROM my_portfolio.current_assets")
        my_result = mycursor.fetchall()
        for x in my_result:
            print(x)
        print(help)

    elif command == "edit":
        name_edit = str.lower(input("Please type security name that you would like to amend > "))
        add_or_subtract = str.lower(input("Would you like to add or subtract from your security? Type add/subtract > "))
        amount_edit = int(input("Please type the amount that you would like to add or subtract > "))
        sql_formula = f"UPDATE current_assets SET amount = (amount + {amount_edit}) WHERE name = '{name_edit}'"
        mycursor.execute(sql_formula)

        mydb.commit()
        mycursor.execute("SELECT * FROM my_portfolio.current_assets")
        my_result = mycursor.fetchall()
        for x in my_result:
            print(x)
        print(help)

    elif command == "reset":
        mycursor.execute("DROP TABLE IF EXISTS current_assets;")

        mycursor.execute("""CREATE TABLE current_assets (
        name varchar(50),
        type varchar(50),
        amount int, 
        value_per_unit_pln int ,  
        value_total_pln int AS (amount * value_per_unit_pln)
        )""")

        sql_formula = "INSERT INTO current_assets (name, type, amount, value_per_unit_pln) VALUES (%s, %s, %s, %s)"
        asset1 = ('btc', "cryptocurrency", 2, 29700)
        asset2 = ('usd', 'currency', 10000, 3.80)
        asset3 = ('cdr', 'shares', 30, 250)

        mycursor.execute(sql_formula, asset1)
        mycursor.execute(sql_formula, asset2)
        mycursor.execute(sql_formula, asset3)

        mydb.commit()
        mycursor.execute("SELECT * FROM my_portfolio.current_assets")
        my_result = mycursor.fetchall()
        for x in my_result:
            print(x)

    elif command == "quit":
        break

    else:
        print(f"""Incorrect command. Please try again' 
              {help}""")
